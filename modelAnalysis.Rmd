---
title: "modelAnalysis.Rmd"
date: 6/2/2023
author: Christine L Hathaway
description: Similar to the code "cleanMatlabOutputs.R", but this code is used to create dataframes that can be used
to make figures. 
---

Things to check: 
- Cancer stage distribution --> does it match with the stage dist before screening? This would be validation. 
- Does all the HPV health states add up to the total number of women in age group? 
- Cervical cancer incidence

# Setup code
```{r}
library(tidyverse)
library(janitor)
library(ggplot2)
library(lubridate)
```

Dictionaries
```{r}
rm(list = ls(all.names = TRUE))

setwd("/Users/clh89/MATLAB/Projects/Kenya_treatment/KECEA/")  # *******SET ME***********
numSces = 0 # number of scenarios to run through

# Translating Matlab indexes for compartments into R factors
ageCateg = data.frame("index" = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17), 
                     "ageCateg" = c("age.0.4", "age.5.9", "age.10.14", "age.15.19", "age.20.24", "age.25.29", "age.30.34", "age.35.39", 
                                      "age.40.44", "age.45.49", "age.50.54", "age.55.59", "age.60.64", "age.65.69", "age.70.74", "age.75.79", "all.ages"))
hpvCateg = data.frame("index" = seq(1,7,1), 
                        "hpvCateg" = c("hpv.susceptible", "hpv.infected", "cin1", "cin2", "cin3", "cc", "hpv.immune"))
dxCateg = data.frame("index" = seq(1,10,1), 
                     "dxCateg" = c("undiagnosed", "undiagnosed", "undiagnosed", "dx, untreated", "dx, untreated", "dx, untreated", "dx, treated", "dx, treated", "dx, treated", "hysterectomy"))
ccStageCateg = data.frame("index" = seq(1,10,1), 
                          "stageCateg" = c("local", "regional", "distant", "local", "regional", "distant", "local", "regional", "distant", "hysterectomy"))
deathsCateg = data.frame("index" = seq(1, 3, 1), 
                         "deathsCateg" = c("treated cc", "untreated cc", "all cause"))
screenTreatCateg = data.frame("index" = seq(1,3,1), 
                              "screenTreatCateg" = c("nScreened", "nColpo", "nCinTreat"))
dxCCTreatCateg = data.frame("treat" = seq(1,3,1), 
                                    "dxType" = c("dx, treated", "dx, untreated", "hysterectomy"))
screenSympCCTreatCateg = data.frame("index" = c(1, 2), 
                                    "screenSymp" = c("screening", "symptoms"))
```


# Scenario 0 testing analysis
```{r}
setwd("/Users/clh89/MATLAB/Projects/Kenya_treatment/KECEA/")  # *******SET ME***********

sceNum <- 0

    deaths = read.csv(paste0("deaths_S", sceNum, ".csv"))
    screenTreat = read.csv(paste0("screenTreat_S", sceNum, ".csv"))
    hpvHealthState = read.csv(paste0("hpvHealthState_S", sceNum, ".csv"))
    totalPerAge = read.csv(paste0("totalPerAge_S", sceNum, ".csv"))
    vax = read.csv(paste0("vax_S", sceNum, ".csv"))
    ccHealthState = read.csv(paste0("ccHealthState_S", sceNum, ".csv"))
    newCC = read.csv(paste0("newCC_S", sceNum, ".csv"))
    screenSympCCTreat = read.csv(paste0("screenSympCCTreat_S", sceNum, ".csv"))
    
    # DEATHS 
    
    deaths_clean <- deaths %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      left_join(., (totalPerAge %>% rename(N=count)), by=c("sceNum", "paramNum", "year", "age")) %>% 
      mutate(deathCateg = case_when(index == 1 ~ "ccDeath_treat", 
                               index == 2 ~ "ccDeath_untreat", 
                               index == 3 ~ "allDeath"), 
             sceNum = sceNum - 1) %>% # the scenario actually starts at 0, but matlab indices start at 1
      select(sceNum, paramNum, year, ageCateg, N, deathCateg, count) %>% unique 
    
    # SCREENING AND TREATMENT
    
    screenTreat_clean <- screenTreat %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      left_join(., screenTreatCateg, by=c("index")) %>% 
      mutate(sceNum = sceNum - 1) %>% 
      select(sceNum, paramNum, year, ageCateg, screenTreatCateg, count) %>% unique %>%
      spread(., screenTreatCateg, count)
    
    # HPV HEALTH STATES
    
    hpvHealthState_clean <- hpvHealthState %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      left_join(., hpvCateg, by=c("healthState" = "index")) %>% 
      mutate(sceNum = sceNum - 1) %>% 
      select(sceNum, paramNum, year, ageCateg, hpvCateg, count) %>% unique %>% 
      spread(., hpvCateg, count)
    
    # CERVICAL CANCER HEALTH STATES 
    
    ccHealthState_clean <- ccHealthState %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      left_join(., ccStageCateg, by=c("endpoint" = "index")) %>% 
      left_join(., dxCateg, by=c("endpoint" = "index")) %>% 
      mutate(sceNum = sceNum - 1, 
             stageCateg_ab = case_when(stageCateg == "local" ~ "l", 
                                       stageCateg == "regional" ~ "r", 
                                       stageCateg == "distant" ~ "d"), 
             dxCateg_ab = case_when(dxCateg == "undiagnosed" ~ "udx", 
                                    dxCateg == "dx, treated" ~ "dx", 
                                    dxCateg == "dx, untreated" ~ "ut"), 
             stageDxCateg = case_when(stageCateg == "hysterectomy" ~ "cc_prev_hyst", 
                                      TRUE ~ paste0("cc_", stageCateg_ab, "_prev_", dxCateg_ab))) %>% 
      select(sceNum, paramNum, year, ageCateg, stageDxCateg, count) %>% unique %>% 
      spread(., stageDxCateg, count) 
    
    # CERVICAL CANCER INCIDENCE (DIAGNOSED CASES) STRATIFIED BY TREATMENT TYPE
    
    screenSympCCTreat_clean <- screenSympCCTreat %>% 
          left_join(., ageCateg, by=c("age" = "index")) %>% 
          left_join(., ccStageCateg, by=c("endpoint" = "index")) %>% 
          left_join(., dxCCTreatCateg, by=c("treat")) %>% 
          left_join(., screenSympCCTreatCateg, by=c("index")) %>% 
          mutate(sceNum = sceNum - 1, 
                 stageCateg_ab = case_when(stageCateg == "local" ~ "l", 
                                           stageCateg == "regional" ~ "r", 
                                           stageCateg == "distant" ~ "d"), 
                 dxCateg_ab = case_when(dxType == "dx, treated" ~ "dx", 
                                        dxType == "dx, untreated" ~ "ut"),  
                 stageDxCateg = case_when(dxType == "hysterectomy" ~ "cc_inc_hyst", 
                                          TRUE ~ paste0("cc_", stageCateg_ab, "_inc_", dxCateg_ab))) %>% 
          group_by(sceNum, paramNum, year, ageCateg, stageDxCateg) %>% 
                  mutate(count2 = sum(count, na.rm=TRUE)) %>% ungroup %>% 
          select(paramNum, sceNum, year, ageCateg, stageDxCateg, count2) %>% unique %>% 
          spread(., stageDxCateg, count2) 
    
    # NEW CERVICAL CANCER CASES 
    
    newCC_clean <- newCC %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      mutate(sceNum = sceNum - 1) %>% 
      select(sceNum, paramNum, year, ageCateg, count) %>% unique %>% 
      rename(newCC = count)
    
    # VACCINATIONS
    vax_clean <- vax %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      mutate(sceNum = sceNum - 1, 
             vaxType = case_when(vaxType == 1 ~ "N_vax_school", 
                                 vaxType == 2 ~ "N_vax_cu")) %>% 
      select(sceNum, paramNum, year, ageCateg, vaxType, count) %>% unique %>% 
      spread(., vaxType, count) 
```

```{r}
# Combine all the dfs
    combined <- deaths_clean %>% 
      left_join(., screenTreat_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., hpvHealthState_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., ccHealthState_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., screenSympCCTreat_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., vax_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., newCC_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      select(sceNum, paramNum, year, ageCateg, N, hpv.susceptible, hpv.immune, hpv.infected, cin1, cin2, cin3,
              cc_l_prev_udx, cc_l_prev_ut, cc_l_prev_dx, 
              cc_r_prev_udx, cc_r_prev_ut, cc_r_prev_dx,
              cc_d_prev_udx, cc_d_prev_ut, cc_d_prev_dx, 
              cc_prev_hyst, 
              cc_l_inc_ut, cc_l_inc_dx, 
              cc_r_inc_ut, cc_r_inc_dx, 
              cc_d_inc_ut, cc_d_inc_dx,
              cc_inc_hyst, 
              newCC, nScreened, nCinTreat, nColpo, 
              allDeath, ccDeath, N_vax_school, N_vax_cu) %>% unique
```



## Deaths

```{r}
deaths_clean %>% 
      filter(deathCateg == "ccDeath_treat") %>% 
      ggplot(., aes(x=year, y=count)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, CC deaths, treated cancers")
```

```{r}
deaths_clean %>% 
      filter(deathCateg == "ccDeath_untreat") %>% 
      ggplot(., aes(x=year, y=count)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, CC deaths, untreated cancers")
```

## Screening and treatment

```{r}
screenTreat_clean %>% 
      ggplot(., aes(x=year, y=nCinTreat)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, CIN treatment")
```

```{r}
screenTreat_clean %>% 
      ggplot(., aes(x=year, y=nColpo)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, colpo")
```

```{r}
screenTreat_clean %>% 
      ggplot(., aes(x=year, y=nScreened)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, screened")
```

## HPV health states

```{r}
hpvHealthState_clean %>% 
      ggplot(., aes(x=year, y=hpv.infected)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, HPV infected")
```

```{r}
hpvHealthState_clean %>% 
      ggplot(., aes(x=year, y=hpv.immune)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, HPV immune")
```

```{r}
hpvHealthState_clean %>% 
      ggplot(., aes(x=year, y=cin1)) + geom_bar(stat="identity") + facet_wrap(~ageCateg) + 
            labs(title="Count, cin1")
```

The sum of all women in each HPV health state adds up to the number of women in age group

```{r}
combined %>% 
      mutate(sum = hpv.susceptible+hpv.immune+hpv.infected+cin1+cin2+cin3) %>% 
      select(year, ageCateg, N, sum) %>% 
      filter(round(N) != round(sum), ageCateg != "all.ages")
```

## Cervical cancer health states

```{r}
ccHealthState_temp <-
      ccHealthState %>% 
      left_join(., ageCateg, by=c("age" = "index")) %>% 
      left_join(., ccStageCateg, by=c("endpoint" = "index")) %>% 
      left_join(., dxCateg, by=c("endpoint" = "index")) %>% 
      mutate(sceNum = sceNum - 1, 
             stageCateg_ab = case_when(stageCateg == "local" ~ "l", 
                                       stageCateg == "regional" ~ "r", 
                                       stageCateg == "distant" ~ "d"), 
             dxCateg_ab = case_when(dxCateg == "undiagnosed" ~ "udx", 
                                    dxCateg == "dx, treated" ~ "dx", 
                                    dxCateg == "dx, untreated" ~ "ut"), 
             stageDxCateg = case_when(stageCateg == "hysterectomy" ~ "cc_prev_hyst", 
                                      TRUE ~ paste0("cc_", stageCateg_ab, "_prev_", dxCateg_ab)))
      # select(sceNum, paramNum, year, ageCateg, stageDxCateg, count) %>% unique %>% 
      # spread(., stageDxCateg, count) 
```

```{r}
ccHealthState_temp %>% 
      filter(stageCateg=="local") %>%
      ggplot(., aes(x=year, y=count, fill=dxCateg)) + geom_bar(stat="identity", position="stack") + facet_wrap(~ageCateg) + 
      labs(title="Local prevalence")
```

```{r}
ccHealthState_temp %>% 
      filter(stageCateg=="regional") %>%
      ggplot(., aes(x=year, y=count, fill=dxCateg)) + geom_bar(stat="identity", position="stack") + facet_wrap(~ageCateg) + 
      labs(title="Regional prevalence")
```

```{r}
ccHealthState_temp %>% 
      filter(stageCateg=="distant") %>%
      ggplot(., aes(x=year, y=count, fill=dxCateg)) + geom_bar(stat="identity", position="stack") + facet_wrap(~ageCateg) + 
      labs(title="Distant prevalence")
```

## New diagnosed CC cases

```{r}
screenSympCCTreat_temp <- screenSympCCTreat %>% 
          left_join(., ageCateg, by=c("age" = "index")) %>% 
          left_join(., ccStageCateg, by=c("endpoint" = "index")) %>% 
          left_join(., dxCCTreatCateg, by=c("treat")) %>% 
          left_join(., screenSympCCTreatCateg, by=c("index")) %>% 
          mutate(sceNum = sceNum - 1, 
                 stageCateg_ab = case_when(stageCateg == "local" ~ "l", 
                                           stageCateg == "regional" ~ "r", 
                                           stageCateg == "distant" ~ "d"), 
                 dxCateg_ab = case_when(dxType == "dx, treated" ~ "dx", 
                                        dxType == "dx, untreated" ~ "ut"),  
                 stageDxCateg = case_when(dxType == "hysterectomy" ~ "cc_inc_hyst", 
                                          TRUE ~ paste0("cc_", stageCateg_ab, "_inc_", dxCateg_ab))) %>% 
          mutate(stageCateg = factor(stageCateg, levels=c("distant", "regional", "local")))
          # group_by(sceNum, paramNum, year, ageCateg, stageDxCateg) %>% 
          #         mutate(count2 = sum(count, na.rm=TRUE)) %>% ungroup 

screenSympCCTreat_temp %>% 
      filter(!ageCateg %in% c("age.0.4", "age.5.9", "age.10.14")) %>% 
      # filter(count != 0) %>% tabyl(ageCateg)
      # filter(ageCateg == "age.40.44") %>% 
      # filter(screenSymp == "symptoms") %>% 
      group_by(year, stageCateg) %>% 
            mutate(sum = sum(count, na.rm=TRUE)) %>% ungroup %>% 
      group_by(year) %>% 
            mutate(total = sum(count), 
                   prop = sum/total) %>% ungroup %>%
      select(year, stageCateg, sum, total, prop) %>% unique %>%
      filter(year == 1950)
      ggplot(., aes(x=year, y=prop, fill=stageCateg)) + geom_bar(stat="identity", position="stack")
```

### Debug

```{r}
screenSympCCTreat_temp %>% 
      group_by(year, stageCateg, dxType, screenSymp) %>% 
            mutate(sum = sum(count)) %>% ungroup %>% 
      select(year, stageCateg, dxType, screenSymp, sum) %>% unique %>% 
      filter(dxType == "dx, untreated") %>% 
      filter(stageCateg == "local") %>% 
      filter(screenSymp == "symptoms")
```


###Validating to the year 2000

```{r}
screenSympCCTreat_temp %>% 
      filter(!ageCateg %in% c("age.0.4", "age.5.9", "age.10.14")) %>%
      # filter(count != 0) %>% tabyl(ageCateg)
      # filter(ageCateg == "age.40.44") %>% 
      # filter(screenSymp == "symptoms") %>% 
      group_by(year, stageCateg) %>% 
            mutate(sum = sum(count, na.rm=TRUE)) %>% ungroup %>% 
      group_by(year) %>% 
            mutate(total = sum(count), 
                   prop = sum/total) %>% ungroup %>% 
      filter(year == 1950) %>% 
      select(stageCateg, prop) %>% unique
```


```{r}
####### TODO
# - Make correction for the first year of vax. I need to think about this more. Because vaxxing all 5-9 means that they will all get vaxxed at some point in the future. 
# - Make a correction for 2 vs 1 dose; will depend on the scenario

    # Combine all the dfs
    combined <- deaths_clean %>% 
      left_join(., screenTreat_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., hpvHealthState_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., ccHealthState_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., screenSympCCTreat_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., vax_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      left_join(., newCC_clean, by=c("sceNum", "paramNum", "year", "ageCateg")) %>% 
      select(sceNum, paramNum, year, ageCateg, N, hpv.susceptible, hpv.immune, hpv.infected, cin1, cin2, cin3,
              cc_l_prev_udx, cc_l_prev_ut, cc_l_prev_dx, 
              cc_r_prev_udx, cc_r_prev_ut, cc_r_prev_dx,
              cc_d_prev_udx, cc_d_prev_ut, cc_d_prev_dx, 
              cc_prev_hyst, 
              cc_l_inc_ut, cc_l_inc_dx, 
              cc_r_inc_ut, cc_r_inc_dx, 
              cc_d_inc_ut, cc_d_inc_dx,
              cc_inc_hyst, 
              newCC, nScreened, nCinTreat, nColpo, 
              allDeath, ccDeath, N_vax_school, N_vax_cu) %>% unique
    
  sceDf <- combined %>% 
    filter(sceNum == sceNum)
  
  ifelse(!dir.exists(paste0(getwd(), "/Outputs")), dir.create(paste0(getwd(), "/Outputs")), FALSE)
  
  write.csv(sceDf, paste0(getwd(), "/Outputs/modelResultsForCea_S", sceNum, ".csv"), row.names = FALSE)
}
```


